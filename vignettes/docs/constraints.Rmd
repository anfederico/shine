---
title: "Structure Learning Constraints"
vignette: >
  %\VignetteIndexEntry{Structure Learning Constraints}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(comment="", cache=FALSE, fig.align="center")
library(tidyr)
library(dplyr)
library(igraph)
devtools::load_all(".")
```

To aid in the inference of networks with small sample sizes, we apply biolgically sensible constraints to learning the network structure. To find constraints for the networks, we first establish a network structure in a lower dimensional space using zero-order correlation between genes, which can be computed with few samples.

```{r, eval=FALSE}
library(shine)
```

# Simulated Data

As an example, we generate an undirected scale-free network using the Barabási–Albert model with 300 nodes (n) and simulate 100 samples (p) that follow a multivariate normal distribution.

### Generate Scale-Free Graph

```{r}
set.seed(123)
g <- model.mpa(300, power=1.3)
model.plot(g)
```

### Simulate Multivariate Gaussian Data
```{r}
set.seed(123)
data <- model.sim(n=75, g)
bdg <- data$bdg
eset <- data$eset
```

# Constraint Methods

We use a specific version of the [Weighted Gene Co-Expression Analysis](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-9-559) method to identify gene modules where are clustered by the similarity (measured by biweight midcorrelation) and hierarchically clustered into gene modules of tightly co-expressed genes. Establishing gene modules captures coordinated co-expression of genes in a network that approximately follows a scale free topology, as do most biological networks, however direct gene-gene connections are abstracted away.

```{r, results='hide', fig.keep='all'}
wgcna <- mods.detect(eset, min.size=5, cores=3, do.plot=TRUE)
```

## Isolated Modules
```{r}
wgcna$mods$grey <- NULL
str(wgcna$mods)
```

The Markov blanket for a node in a graphical model contains all the variables that shield the node from the rest of the network. This means that the Markov blanket of a node is the only knowledge needed to predict the behavior of that node and its children.

In our case, for each gene, its markov blanket includes genes within its own module. These blankets makeup the constraint on the network, which vastly reduces the complexity of the search space. If the constraints prevent an edge between two genes, there will be a zero-entry in the matrix, otherwise the probability of an edge will be 0.5, assuming no other prior information is being incorporated.

```{r}
blanket <- blanket.new(wgcna$genes)
blanket <- blanket.lift(blanket, wgcna$mods)
```

Here we relay the modules back on the true graphs structure...
```{r}
V(g)$color <- wgcna$colors
model.plot(g, colors=TRUE)
```

```{r}
blanket.cred(blanket)
```

## Fuzzy Modules
```{r fig.height=12, fig.width=12}
mods.plot(wgcna$dat, wgcna$mods, wgcna$colors, size=2)
```

```{r}
mod.plot(wgcna$dat, wgcna$mods, mod="green", wgcna$colors, size=2)
```

```{r}
fuzzy.plot(wgcna$dat, wgcna$mods, mod="green", size=2)
```

```{r}
fuzzy <- fuzzy.mods(wgcna$dat, wgcna$mods)

blanket <- blanket.new(wgcna$genes)
blanket <- blanket.lift(blanket, fuzzy)
blanket.cred(blanket)
```

## Metanet

Using a meta network of co-regulated gene modules, we can represent each module as an eigenvector, which is the first principle component (PC1) of the expression values of genes within a given module, resulting in a module x sample matrix. Within this lower-dimensional representation of the network, we establish conditional independence between modules by measuring the pairwise partial correlation.

```{r}
wgcna$mods$grey <- NULL    
wgcna$eigengenes$grey <- NULL
  
# Estimate meta network
metanet <- bdg.metanet(wgcna$eigengenes, mpl=TRUE, iter=25000, print=5000, cores=3)
``` 

```{r}
V(metanet$ig)$color <- names(V(metanet$ig))
plot(metanet$ig, vertex.size=10, edge.width=3, vertex.label=NA)
```

```{r} 
blanket <- blanket.new(wgcna$genes)
blanket <- blanket.lift(blanket, wgcna$mods, metanet$edges)
blanket.cred(blanket)
```
